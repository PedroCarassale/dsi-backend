name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quick-checks:
    name: ðŸš€ ValidaciÃ³n RÃ¡pida
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Para comparaciones de diff

      - name: ðŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Instalar dependencias
        run: npm ci

      - name: ðŸ” Linting
        run: npm run lint

      - name: ðŸ—ï¸ Build
        run: npm run build

  comment-pr:
    name: ðŸ’¬ Comentario en PR
    runs-on: ubuntu-latest
    needs: quick-checks
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: âœ… Comentario de Ã©xito
        if: needs.quick-checks.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Quick checks pasaron!** El cÃ³digo estÃ¡ listo para revisiÃ³n.\n\n' +
                    '- âœ… Linting\n' +
                    '- âœ… Build\n\n' +
                    '_Los tests E2E completos se ejecutarÃ¡n cuando se haga merge a main/develop._'
            })

      - name: âŒ Comentario de error
        if: needs.quick-checks.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Quick checks fallaron!** Por favor revisa los errores.\n\n' +
                    'Revisa los detalles en la pestaÃ±a Actions.'
            })

  pr-info:
    name: ðŸ“Š InformaciÃ³n del PR
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š EstadÃ­sticas del PR
        run: |
          echo "### ðŸ“Š EstadÃ­sticas del Pull Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | wc -l)
          LINES_ADDED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{sum+=$1} END {print sum}')
          LINES_DELETED=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | awk '{sum+=$2} END {print sum}')

          echo "| MÃ©trica | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Archivos modificados | $FILES_CHANGED |" >> $GITHUB_STEP_SUMMARY
          echo "| âž• LÃ­neas aÃ±adidas | $LINES_ADDED |" >> $GITHUB_STEP_SUMMARY
          echo "| âž– LÃ­neas eliminadas | $LINES_DELETED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "#### ðŸ“ Archivos modificados:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
